# Research: Configurable Source Attribute

**Feature**: 009-configurable-source-attr
**Date**: 2025-11-27

## Research Summary

This feature is straightforward with no significant unknowns. The `sourceTrackingPrefix` configuration already exists in the codebase - the implementation focuses on validation and ensuring consistent usage.

## Decision 1: HTML Attribute Name Validation

**Question**: What constitutes a valid HTML attribute name prefix?

**Decision**: Use HTML5 attribute name rules - alphanumeric characters, hyphens (-), underscores (_), and periods (.). The prefix combined with the base name (e.g., "source") must form a valid attribute name.

**Rationale**: HTML5 is lenient but browsers enforce basic rules. Using a permissive regex that catches obvious errors while allowing standard patterns like `data-*` prefixes.

**Alternatives considered**:
- Strict XML naming rules: Too restrictive, rejects common patterns like `data-my-attr`
- No validation: Risky, could produce invalid HTML silently

**Validation regex**: `/^[a-zA-Z_][a-zA-Z0-9_-]*$/` for non-empty prefixes (empty string is also valid)

## Decision 2: Empty String Handling

**Question**: Should empty string be a valid prefix?

**Decision**: Yes, empty string results in unprefixed attributes (`source`, `source-op`, `source-note`).

**Rationale**: Some users may want minimal attribute names without any prefix. This is a legitimate use case and produces valid HTML.

**Alternatives considered**:
- Require non-empty prefix: Too restrictive, limits flexibility
- Use `null` for no prefix: Inconsistent with string type

## Decision 3: Validation Timing

**Question**: When should prefix validation occur?

**Decision**: Validate at render context creation time, before any rendering begins.

**Rationale**: Fail-fast approach ensures errors are caught immediately with clear messages, rather than producing partial output with invalid attributes.

**Alternatives considered**:
- Validate at config creation: Would require wrapping the config object
- Validate at first attribute generation: Too late, could produce partial output

## Decision 4: Existing Implementation Status

**Question**: Is source tracking currently implemented in the renderer?

**Research Findings**: The `sourceTrackingPrefix` config exists in `RenderConfig` with default `'rd-'`, but source tracking attributes are not yet being generated by the renderer. The `includeSourceTracking`, `includeOperationTracking`, and `includeNoteGeneration` flags exist but the attribute generation code is not implemented.

**Decision**: This feature focuses on:
1. Adding prefix validation
2. Creating a helper function to generate attribute names using the prefix
3. Ensuring the prefix is used consistently when source tracking is implemented

The actual source tracking implementation (generating the attribute values from data paths) is out of scope for this feature - that's a separate, larger effort.

## Technical Notes

### Attribute Name Pattern

```typescript
// Validation regex for prefix
const VALID_PREFIX_REGEX = /^[a-zA-Z_][a-zA-Z0-9_-]*$/;

// Helper to generate attribute name
function getSourceAttrName(prefix: string, base: 'source' | 'source-op' | 'source-note'): string {
  return prefix + base;
}
```

### Generated Attribute Names

| Prefix | source | source-op | source-note |
|--------|--------|-----------|-------------|
| `rd-` (default) | `rd-source` | `rd-source-op` | `rd-source-note` |
| `data-track-` | `data-track-source` | `data-track-source-op` | `data-track-source-note` |
| `` (empty) | `source` | `source-op` | `source-note` |
| `audit_` | `audit_source` | `audit_source-op` | `audit_source-note` |

## References

- HTML5 Attribute Naming: https://html.spec.whatwg.org/multipage/syntax.html#attributes-2
- Existing RenderConfig: `packages/blade/src/renderer/index.ts:141-149`
- Default prefix: `packages/blade/src/renderer/index.ts:205`
